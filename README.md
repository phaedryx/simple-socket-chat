Code based on this gist: https://gist.github.com/940468
